<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Student Count Analytics</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet"/>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #0a0e1a; color: #e2e8f0; font-family: 'Syne', sans-serif; min-height: 100vh; padding: 32px 20px; }

  .wrapper { max-width: 1100px; margin: 0 auto; }

  .logo { font-size: 11px; text-transform: uppercase; letter-spacing: 4px; color: #334155; font-family: 'Space Mono', monospace; margin-bottom: 10px; }
  h1 { font-size: 28px; font-weight: 800; color: #f1f5f9; margin-bottom: 8px; }
  h1 span { color: #00e5ff; }
  .subtitle { color: #475569; font-size: 14px; margin-bottom: 40px; }
  .subtitle code { font-family: 'Space Mono', monospace; color: #64748b; }

  .dropzone {
    border: 2px dashed #1e2d40;
    border-radius: 14px;
    padding: 60px 48px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: #111827;
    position: relative;
  }
  .dropzone.drag, .dropzone:hover { border-color: #00e5ff; background: #0d1f33; box-shadow: 0 0 60px rgba(0,229,255,0.08); }
  .dropzone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
  .drop-icon { font-size: 52px; margin-bottom: 16px; display: block; animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:0.4} 50%{opacity:1} }
  .drop-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
  .drop-sub { color: #475569; font-size: 14px; }
  .error-msg { color: #f87171; margin-top: 16px; font-size: 13px; font-family: 'Space Mono', monospace; }

  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
  .stat-card { background: #111827; border: 1px solid #1e2d40; border-radius: 10px; padding: 20px 24px; position: relative; overflow: hidden; }
  .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, #00e5ff, transparent); }
  .stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: #64748b; font-family: 'Space Mono', monospace; margin-bottom: 8px; }
  .stat-value { font-size: 32px; font-weight: 800; color: #00e5ff; font-family: 'Space Mono', monospace; line-height: 1; }
  .stat-sub { font-size: 13px; color: #94a3b8; margin-top: 6px; }

  .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
  .chart-card { background: #111827; border: 1px solid #1e2d40; border-radius: 12px; padding: 28px; }
  .chart-title { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 3px; color: #64748b; font-family: 'Space Mono', monospace; margin-bottom: 20px; }

  .rank-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
  .rank-num { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-family: 'Space Mono', monospace; flex-shrink: 0; }
  .rank-info { flex: 1; min-width: 0; }
  .rank-name { font-size: 12px; color: #94a3b8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .rank-bar-bg { height: 4px; border-radius: 2px; background: #1e2d40; margin-top: 4px; }
  .rank-bar { height: 100%; border-radius: 2px; }
  .rank-count { font-family: 'Space Mono', monospace; font-size: 14px; font-weight: 700; flex-shrink: 0; }

  .reset-btn { display: block; margin: 0 auto 32px; background: transparent; border: 1px solid #1e2d40; color: #475569; padding: 10px 28px; border-radius: 8px; cursor: pointer; font-family: 'Space Mono', monospace; font-size: 13px; transition: all 0.2s; }
  .reset-btn:hover { border-color: #00e5ff; color: #00e5ff; }

  #dashboard { display: none; }

  @media (max-width: 800px) { .stats-grid, .charts-grid { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<div class="wrapper">
  <p class="logo">YOLOv8 Â· Computer Vision</p>
  <h1>Student Count <span>Analytics</span></h1>
  <p class="subtitle">Drop your <code>all_images_counts.csv</code> to visualize results</p>

  <div class="dropzone" id="dropzone">
    <input type="file" accept=".csv" id="fileInput"/>
    <span class="drop-icon">ðŸ“Š</span>
    <p class="drop-title">Drop your CSV here</p>
    <p class="drop-sub">or click to browse</p>
    <p class="error-msg" id="errorMsg" style="display:none"></p>
  </div>

  <div id="dashboard">
    <div class="stats-grid">
      <div class="stat-card"><p class="stat-label">Total Images</p><p class="stat-value" id="s-total">â€”</p><p class="stat-sub">processed</p></div>
      <div class="stat-card"><p class="stat-label">Avg Students</p><p class="stat-value" id="s-avg">â€”</p><p class="stat-sub">per image</p></div>
      <div class="stat-card"><p class="stat-label">Max Count</p><p class="stat-value" id="s-max">â€”</p><p class="stat-sub">in 1 image</p></div>
      <div class="stat-card"><p class="stat-label">Zero Count</p><p class="stat-value" id="s-zero">â€”</p><p class="stat-sub">empty images</p></div>
    </div>

    <div class="charts-grid">
      <div class="chart-card">
        <p class="chart-title">Distribution of Student Counts</p>
        <canvas id="histChart"></canvas>
      </div>
      <div class="chart-card">
        <p class="chart-title" id="trendTitle">Count Per Image (Sequence)</p>
        <canvas id="trendChart"></canvas>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-card">
        <p class="chart-title">Highest Count Images</p>
        <div id="topList"></div>
      </div>
      <div class="chart-card">
        <p class="chart-title">Lowest Count Images</p>
        <div id="bottomList"></div>
      </div>
    </div>

    <button class="reset-btn" onclick="resetDash()">â†‘ Load Different CSV</button>
  </div>
</div>

<script>
  let histInst = null, trendInst = null;

  const dz = document.getElementById('dropzone');
  dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('drag'));
  dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('drag'); handleFile(e.dataTransfer.files[0]); });
  document.getElementById('fileInput').addEventListener('change', e => handleFile(e.target.files[0]));

  function handleFile(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => processCSV(e.target.result);
    reader.readAsText(file);
  }

  function showError(msg) {
    const el = document.getElementById('errorMsg');
    el.textContent = msg;
    el.style.display = 'block';
  }

  function processCSV(text) {
    try {
      const lines = text.trim().split(/\r?\n/);
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const rows = lines.slice(1).map(line => {
        const vals = line.split(',').map(v => v.trim().replace(/"/g, ''));
        const obj = {};
        headers.forEach((h, i) => obj[h] = vals[i] || '');
        return obj;
      }).filter(r => Object.values(r).some(v => v));

      if (!rows.length) { showError('CSV appears empty.'); return; }

      const countCol = headers.find(k => /count|student|person|people|num/i.test(k))
        || headers.find(k => rows.some(r => r[k] !== '' && !isNaN(+r[k])));
      const nameCol  = headers.find(k => /name|file|image|img|path/i.test(k));
      const timeCol  = headers.find(k => /time|date|stamp|hour|minute/i.test(k));

      if (!countCol) { showError('Could not find a numeric count column in your CSV.'); return; }

      const parsed = rows.map((r, i) => ({
        index: i + 1,
        name: nameCol ? r[nameCol] : 'Image ' + (i + 1),
        count: +r[countCol] || 0,
        time: timeCol ? r[timeCol] : null,
      }));

      const counts = parsed.map(r => r.count);
      const avg = counts.reduce((a,b)=>a+b,0) / counts.length;
      const maxCount = Math.max(...counts);

      document.getElementById('s-total').textContent = parsed.length;
      document.getElementById('s-avg').textContent   = avg.toFixed(1);
      document.getElementById('s-max').textContent   = maxCount;
      document.getElementById('s-zero').textContent  = counts.filter(c=>c===0).length;

      // Histogram
      const hist = {};
      for (let v = Math.min(...counts); v <= maxCount; v++) hist[v] = 0;
      counts.forEach(v => hist[v]++);
      const hLabels = Object.keys(hist).map(Number);
      const hValues = Object.values(hist);
      const hColors = hLabels.map(v => {
        const p = v / maxCount;
        return p > 0.75 ? 'rgba(255,107,53,0.85)' : p > 0.4 ? 'rgba(0,229,255,0.85)' : 'rgba(2,132,199,0.85)';
      });

      if (histInst) histInst.destroy();
      const hCtx = document.getElementById('histChart').getContext('2d');
      histInst = new Chart(hCtx, {
        type: 'bar',
        data: { labels: hLabels, datasets: [{ data: hValues, backgroundColor: hColors, borderRadius: 4, borderSkipped: false }] },
        options: {
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { title: i => i[0].label + ' students', label: i => i.raw + ' images' } }
          },
          scales: {
            x: { grid:{color:'#1e2d40'}, ticks:{color:'#475569',font:{family:'Space Mono',size:11}}, title:{display:true,text:'Number of Students',color:'#475569',font:{family:'Space Mono',size:11}} },
            y: { grid:{color:'#1e2d40'}, ticks:{color:'#475569',font:{family:'Space Mono',size:11}}, title:{display:true,text:'Images',color:'#475569',font:{family:'Space Mono',size:11}} }
          }
        }
      });

      // Trend
      const trendData = timeCol ? [...parsed].sort((a,b)=>a.time>b.time?1:-1) : parsed;
      if (timeCol) document.getElementById('trendTitle').textContent = 'Trend Over Time';

      if (trendInst) trendInst.destroy();
      const tCtx = document.getElementById('trendChart').getContext('2d');
      const grad = tCtx.createLinearGradient(0, 0, 0, 280);
      grad.addColorStop(0, 'rgba(0,229,255,0.3)');
      grad.addColorStop(1, 'rgba(0,229,255,0)');

      trendInst = new Chart(tCtx, {
        type: 'line',
        data: {
          labels: trendData.map(r => timeCol ? r.time : r.index),
          datasets: [{
            data: trendData.map(r => r.count),
            borderColor: '#00e5ff', borderWidth: 2,
            backgroundColor: grad, fill: true,
            pointRadius: 0, pointHoverRadius: 4, tension: 0.3
          }]
        },
        options: {
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { title: i => timeCol ? i[0].label : 'Image ' + i[0].label, label: i => i.raw + ' students' } }
          },
          scales: {
            x: { grid:{color:'#1e2d40'}, ticks:{color:'#475569',font:{family:'Space Mono',size:10},maxTicksLimit:10} },
            y: { grid:{color:'#1e2d40'}, ticks:{color:'#475569',font:{family:'Space Mono',size:11}} }
          }
        }
      });

      // Rank lists
      renderList('topList',    [...parsed].sort((a,b)=>b.count-a.count).slice(0,5), maxCount, '#ff6b35');
      renderList('bottomList', [...parsed].sort((a,b)=>a.count-b.count).slice(0,5), maxCount, '#64748b');

      dz.style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';

    } catch(e) { showError('Failed to parse CSV: ' + e.message); }
  }

  function renderList(id, items, maxCount, color) {
    document.getElementById(id).innerHTML = items.map((r, i) => `
      <div class="rank-row">
        <div class="rank-num" style="background:${color}22;border:1px solid ${color}44;color:${color}">${i+1}</div>
        <div class="rank-info">
          <div class="rank-name" title="${r.name}">${r.name}</div>
          <div class="rank-bar-bg"><div class="rank-bar" style="width:${maxCount?((r.count/maxCount)*100):0}%;background:${color}"></div></div>
        </div>
        <span class="rank-count" style="color:${color}">${r.count}</span>
      </div>`).join('');
  }

  function resetDash() {
    if (histInst) { histInst.destroy(); histInst = null; }
    if (trendInst) { trendInst.destroy(); trendInst = null; }
    document.getElementById('dashboard').style.display = 'none';
    dz.style.display = 'block';
    document.getElementById('fileInput').value = '';
    document.getElementById('errorMsg').style.display = 'none';
    document.getElementById('trendTitle').textContent = 'Count Per Image (Sequence)';
  }
</script>
</body>
</html>
